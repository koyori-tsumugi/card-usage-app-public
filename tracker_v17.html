<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ã‚«ãƒ¼ãƒ‰ä½¿ç”¨é¡ãƒˆãƒ©ãƒƒã‚«ãƒ¼ v9.2ï¼ˆæœªæ¥ã®ã¿é©ç”¨ãƒ»å‰Šé™¤ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰ãƒ»ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸï¼‰</title>
<style>
  :root { --bg:#eff6ff; --card:#fff; --border:#dbeafe; --accent:#0ea5e9; --accent2:#0369a1; --muted:#6b7280; --text:#0f172a; --warn:#f43f5e; --ok:#10b981; --warn2:#f59e0b; }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif; background:var(--bg); color:var(--text)}
  .wrap{max-width:720px; margin:0 auto; padding:16px; padding-bottom:110px;}
  .row{display:flex; gap:12px; align-items:flex-end; flex-wrap:wrap}
  .card{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 1px 6px rgba(0,0,0,.05); margin-bottom:16px}
  h1{font-size:18px; margin:0 0 2px} .sub{font-size:12px; color:var(--muted)}
  label{font-size:12px; color:var(--muted); display:block; margin-bottom:4px}
  input,select,textarea{width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:12px; font-size:16px; outline:none}
  textarea{min-height:84px}
  input:focus,select:focus,textarea:focus{border-color:#93c5fd; box-shadow:0 0 0 3px #bfdbfe}
  .btn{height:42px; padding:0 14px; border-radius:12px; border:1px solid var(--border); background:var(--accent); color:#fff; font-weight:600; cursor:pointer}
  .btn.ghost{background:#fff; color:var(--text)}
  .bar{height:8px; width:100%; background:#e0f2fe; border-radius:999px; overflow:hidden}
  .bar>div{height:100%; background:var(--accent); transition:width .2s}
  ul{list-style:none; padding:0; margin:0}
  li{display:flex; align-items:center; gap:12px; padding:12px; border-top:1px solid #eef2ff}
  .date{width:88px; font-size:12px; color:var(--muted)}
  .amt{font-weight:700}
  .chip{margin-left:6px; font-size:10px; background:#fde68a; color:#92400e; padding:2px 6px; border-radius:999px}
  .status{font-size:12px; color:var(--muted)}
  .footer{position:fixed; left:0; right:0; bottom:12px; z-index:20}
  .footer>div{max-width:720px; margin:0 auto; display:flex; align-items:center; gap:12px; background:#fff; border:1px solid var(--border); border-radius:16px; padding:12px; box-shadow:0 1px 8px rgba(0,0,0,.06)}
  .hidden{display:none}
  .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.15); padding:16px; z-index:30}
  .modal.show{display:flex}
  .modal>.panel{background:#fff; border:1px solid var(--border); border-radius:16px; width:min(680px,100%); max-height:90vh; overflow:auto; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.2)}
  .row-mid{display:flex; align-items:center; gap:8px; flex-wrap:wrap}

  .payday-counter{display:grid; gap:8px}
  .payday-eta{font-size:20px; font-weight:800}
  .payday-eta.ok{color:var(--ok)}
  .badges{display:flex; gap:8px; flex-wrap:wrap}
  .badge{padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border); background:#fff}
  /* èªè¨¼UIã‚’æœ€å‰é¢ã¸ */
  #authArea { position: relative; z-index: 50; }
  #authArea .btn { pointer-events: auto; }

  /* è¿½åŠ ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¡¨ç¤ºãƒˆã‚°ãƒ«ã®è¦‹ãŸç›®èª¿æ•´ï¼‰ */
  .pwd-wrap {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .pwd-wrap .eye.btn {
    height: 42px;             /* æ—¢å­˜ .btn ã¨é«˜ã•ã‚’ãã‚ãˆã‚‹ */
    padding: 0 10px;
    white-space: nowrap;
  }


</style>

<script>
function installEyeToggleFor(inputId) {
  const input = document.getElementById(inputId);
  if (!input || input.dataset.eyeInstalled) return;
  input.dataset.eyeInstalled = '1';

  // è¦ªã‚’ç›¸å¯¾é…ç½®ã«
  const wrapper = document.createElement('span');
  wrapper.style.position = 'relative';
  wrapper.style.display = 'inline-block';
  input.parentNode.insertBefore(wrapper, input);
  wrapper.appendChild(input);

  // ç›®ãƒœã‚¿ãƒ³
  const btn = document.createElement('button');
  btn.type = 'button';
  btn.setAttribute('aria-label', 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®è¡¨ç¤º/éè¡¨ç¤º');
  btn.style.position = 'absolute';
  btn.style.right = '8px';
  btn.style.top = '50%';
  btn.style.transform = 'translateY(-50%)';
  btn.style.padding = '0 6px';
  btn.style.height = '28px';
  btn.style.border = '1px solid var(--border)';
  btn.style.borderRadius = '8px';
  btn.style.background = '#fff';
  btn.style.cursor = 'pointer';
  btn.textContent = 'ğŸ‘';

  btn.addEventListener('click', () => {
    const show = input.type === 'password';
    input.type = show ? 'text' : 'password';
    btn.textContent = show ? 'â—' : 'ğŸ‘';
  });

  wrapper.appendChild(btn);
}
</script>


<script>
  // ãƒœã‚¿ãƒ³ãŒç„¡ãã¦ã‚‚è‡ªå‹•ã§ä½œã£ã¦å¾Œç½®ãã™ã‚‹ç‰ˆï¼ˆã©ã®ç«¯æœ«ã§ã‚‚å‹•ãï¼‰
  window.installEyeToggleFor = function(id){
    const input = document.getElementById(id);
    if (!input) return;

    // æ—¢å­˜ãƒœã‚¿ãƒ³ã‚’æ¢ã™ / ãªã‘ã‚Œã°ä½œã‚‹
    let btn = document.querySelector(`button.eye[data-eye="${id}"]`);
    if (!btn) {
      btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'btn ghost eye';
      btn.dataset.eye = id;
      btn.style.marginLeft = '8px';
      btn.style.height = '42px';
      btn.textContent = 'ğŸ‘';
      // å…¥åŠ›ã®ã™ãå¾Œã‚ã«ç½®ãï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¯ãŠå¥½ã¿ã§ï¼‰
      input.insertAdjacentElement('afterend', btn);
    }

    const update = (show)=>{
      input.type = show ? 'text' : 'password';
      btn.setAttribute('aria-pressed', String(show));
      btn.setAttribute('aria-label', show ? 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’éè¡¨ç¤º' : 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¡¨ç¤º');
      btn.textContent = show ? 'ğŸ™ˆ' : 'ğŸ‘';
    };

    btn.addEventListener('click', ()=>{
      const show = input.type === 'password';
      update(show);
      // iOS/Androidã§ã‚‚ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚’ç¶­æŒ
      input.focus({preventScroll:true});
    }, {passive:true});

    // åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤ºï¼ˆpasswordï¼‰
    update(false);
  };
</script>


</head>
<body>
  <main class="wrap">
    <header class="row" style="align-items:center; margin-bottom:12px">
      <div>
        <h1>ã‚«ãƒ¼ãƒ‰ä½¿ç”¨é¡ãƒˆãƒ©ãƒƒã‚«ãƒ¼ï¼ˆè¤‡æ•°ã‚«ãƒ¼ãƒ‰ï¼‰</h1>
        <div class="sub">çµ¦æ–™æ—¥ã¯ä¼‘æ—¥ãªã‚‰å‰å–¶æ¥­æ—¥ã«ç¹°ä¸Šã’ï¼å®šä¾‹ã¯å¹³æ—¥èª¿æ•´ãªã—ï¼ãƒ†ãƒ³ãƒ—ãƒ¬ã¯å½“æœˆä»¥é™ã®ã¿è‡ªå‹•é©ç”¨ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰</div>
      </div>
    </header>

    <!-- payday counter -->
    <section class="card" id="paydayCounterCard">
      <h2 style="font-size:14px; margin:0 0 8px">çµ¦æ–™æ—¥ã¾ã§ã®ã‚«ã‚¦ãƒ³ãƒˆ</h2>
      <div class="payday-counter">
        <div class="sub">ãƒ™ãƒ¼ã‚¹çµ¦æ–™æ—¥ï¼ˆåœŸæ—¥/ç¥æ—¥ã¯å‰å–¶æ¥­æ—¥ã«ç¹°ä¸Šã’ï¼‰</div>
        <div id="pdEta" class="payday-eta">â€”</div>
        <div class="bar"><div id="pdBar" style="width:0%"></div></div>
        <div id="pdRange" class="sub">â€”</div>
        <div class="badges">
          <span id="pdBadgeBase" class="badge">ãƒ™ãƒ¼ã‚¹: â€”æ—¥</span>
          <span id="pdBadgePrev" class="badge">å‰å›: â€”</span>
          <span id="pdBadgeThis" class="badge">ä»Šå›: â€”</span>
          <span id="pdBadgeDays" class="badge">å…¨: â€”æ—¥</span>
          <span id="pdBadgePct" class="badge">é€²æ—: â€”%</span>
        </div>
      </div>
    </section>

    <!-- month & total -->
    <section class="card">
      <div class="row" style="align-items:flex-end">
        <div style="flex:1 1 200px">
          <label>æœˆï¼ˆã‚¢ãƒ³ã‚«ãƒ¼ï¼šæ¬¡ã®çµ¦æ–™æ—¥ã®â€œçµ‚ã‚ã‚Šæœˆâ€ï¼‰</label>
          <input id="month" type="month">
          <div id="periodRange" class="sub" style="margin-top:4px">â€”</div>
        </div>
        <div class="row" style="flex:0 0 auto; align-items:center">
          <button id="prevMonth" class="btn ghost" type="button">â—€ å‰æœˆ</button>
          <button id="nextMonth" class="btn ghost" type="button">ç¿Œæœˆ â–¶</button>
        </div>
        <button id="manageCards" class="btn" type="button">ã‚«ãƒ¼ãƒ‰ç®¡ç†</button>
        <button id="manageTemplates" class="btn" type="button">å®šä¾‹æ”¯å‡º</button>
        <button id="openSettings" class="btn ghost" type="button">è¨­å®š</button>
      </div>
      <div style="margin-top:12px">
        <div style="display:flex; justify-content:space-between; font-size:14px"><span class="sub">åˆè¨ˆä½¿ç”¨é¡</span><b id="usedTotal">Â¥0</b></div>
        <div class="bar"><div id="barTotal" style="width:0%"></div></div>
        <div style="display:flex; justify-content:space-between; font-size:14px; margin-top:2px"><span class="sub">åˆè¨ˆæ®‹ã‚Šæ ï¼ˆç›®æ¨™åˆè¨ˆï¼‰</span><b id="remainTotal">ç›®æ¨™æœªè¨­å®š</b></div>
        <div class="sub" style="margin-top:4px">â€» åˆè¨ˆç›®æ¨™ï¼å„ã‚«ãƒ¼ãƒ‰ã®ç›®æ¨™ã®åˆè¨ˆ</div>
      </div>
    </section>

    <section id="cardsSummary" class="mb-2"></section>

    <!-- add/edit form -->
    <section class="card">
      <h2 style="font-size:14px; margin:0 0 8px">æ”¯å‡ºã‚’è¿½åŠ  / ç·¨é›†</h2>
      <div class="row">
        <div style="flex:1 1 180px"><label>ã‚«ãƒ¼ãƒ‰</label><select id="cardSelect"></select></div>
        <div style="flex:1 1 160px"><label>æ—¥ä»˜</label><input id="date" type="date"></div>
        <div style="flex:1 1 140px"><label>é‡‘é¡ (å††)</label><input id="amount" inputmode="numeric" placeholder="ä¾‹: 1200 / ï¼‘ï¼’ï¼ï¼ / ï¿¥1,200"></div>
        <div style="flex:1 1 100%"><label>ãƒ¡ãƒ¢</label><input id="memo" type="text"></div>
        <div style="flex:1 1 100%; font-size:12px; color:var(--muted)"><label><input id="estimated" type="checkbox"> æ¦‚ç®—</label></div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="add" class="btn" type="button" style="flex:1">è¿½åŠ </button>
        <button id="update" class="btn hidden" type="button" style="flex:1">æ›´æ–°</button>
        <button id="cancelEdit" class="btn ghost hidden" type="button">ç·¨é›†ã‚’ã‚„ã‚ã‚‹</button>
        <button id="clearForm" class="btn ghost" type="button">ã‚¯ãƒªã‚¢</button>
      </div>
    </section>

    <!-- list -->
    <section class="card" id="listSection">
      <div class="row" style="align-items:center">
        <h2 style="font-size:14px; margin:0">ä»Šæœˆã®æ˜ç´°</h2>
        <select id="filterCard" style="margin-left:auto; width:auto"><option value="">ï¼ˆã™ã¹ã¦ã®ã‚«ãƒ¼ãƒ‰ï¼‰</option></select>
        <button id="exportCsv" class="btn ghost" type="button" style="font-size:12px">CSVæ›¸å‡º</button>
        <button id="backup" class="btn ghost" type="button" style="font-size:12px">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
        <label class="btn ghost" style="font-size:12px; display:inline-flex; align-items:center; gap:6px; cursor:pointer">å¾©å…ƒ
          <input id="restore" type="file" accept="application/json" style="display:none">
        </label>
      </div>
      <ul id="list"></ul>
    </section>

    <!-- ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸï¼ˆãƒ­ã‚°ã‚¤ãƒ³ï¼‰ -->
    <section class="card">
      <h2 style="font-size:14px;margin:0 0 8px">ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸï¼ˆãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ï¼‰</h2>
      
      <div id="authArea">
        <input id="sEmail" type="email" placeholder="ãƒ¡ãƒ¼ãƒ«" autocomplete="username">

        <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ + ç›®ãƒœã‚¿ãƒ³ -->
        <div class="pwd-wrap">
          <input id="sPw" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" autocomplete="current-password">
          <button type="button"
                  class="btn ghost eye"
                  data-eye="sPw"
                  aria-pressed="false"
                  aria-label="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¡¨ç¤º">ğŸ‘</button>
        </div>

        <button id="sSignup" class="btn" type="button">æ–°è¦ç™»éŒ²</button>
        <button id="sLogin" class="btn" type="button">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <button id="sResetPw" class="btn ghost" type="button">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãŠå¿˜ã‚Œã§ã™ã‹ï¼Ÿ</button>
      </div>

      <div id="syncArea" class="row" style="display:none">
        <div class="sub">ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š<b id="sWho"></b></div>
        <button id="cloudSave" class="btn" type="button">ã‚¯ãƒ©ã‚¦ãƒ‰ä¿å­˜</button>
        <button id="cloudLoad" class="btn ghost" type="button">ã‚¯ãƒ©ã‚¦ãƒ‰èª­è¾¼</button>
        <button id="sLogout" class="btn ghost" type="button">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
      <div id="syncMsg" class="sub"></div>
    </section>

    <nav class="footer">
      <div>
        <button id="gotoToday" class="btn" type="button" style="background:var(--accent2)">ä»Šæœˆã¸</button>
        <div class="sub">åˆè¨ˆ <b id="sumFooter">Â¥0</b></div>
        <div class="sub" id="status" style="margin-left:auto">â€”</div>
      </div>
    </nav>
  </main>

  <!-- card modal -->
  <div id="cardModal" class="modal">
    <div class="panel">
      <div class="row-mid">
        <h3 style="margin:0">ã‚«ãƒ¼ãƒ‰ç®¡ç†</h3>
        <button id="closeCardModal" class="btn ghost" type="button" style="margin-left:auto; height:auto; padding:6px 10px">é–‰ã˜ã‚‹</button>
      </div>
      <div class="sub" style="margin-top:4px">ã‚«ãƒ¼ãƒ‰åã¨æœˆã®ç›®æ¨™é¡ï¼ˆæ ï¼‰ã‚’ç·¨é›†ãƒ»è¿½åŠ ã§ãã¾ã™</div>
      <ul id="cardList" class="mb-2" style="margin-top:8px"></ul>
      <div class="row-mid" style="margin-top:6px">
        <input id="newCardName" placeholder="ã‚«ãƒ¼ãƒ‰å" style="flex:1 1 auto">
        <input id="newCardTarget" placeholder="ç›®æ¨™é¡" inputmode="numeric" style="width:160px">
        <button id="addCard" class="btn" type="button">ã‚«ãƒ¼ãƒ‰è¿½åŠ </button>
      </div>
    </div>
  </div>

  <!-- template modal -->
  <div id="tplModal" class="modal">
    <div class="panel">
      <div class="row-mid">
        <h3 style="margin:0">å®šä¾‹æ”¯å‡ºï¼ˆæ¯æœˆè‡ªå‹•è¿½åŠ ï¼å¹³æ—¥èª¿æ•´ãªã—ï¼‰</h3>
        <button id="closeTplModal" class="btn ghost" type="button" style="margin-left:auto; height:auto; padding:6px 10px">é–‰ã˜ã‚‹</button>
      </div>
      <div class="sub" style="margin-top:4px">æŒ‡å®šã—ãŸæ—¥ä»˜ã§ãã®ã¾ã¾ç™»éŒ²ã—ã¾ã™ï¼ˆä¼‘æ—¥ã§ã‚‚ç§»å‹•ã—ã¾ã›ã‚“ï¼‰</div>
      <ul id="tplList" style="margin-top:8px"></ul>
      <div class="row-mid" style="margin-top:10px">
        <select id="tplCard" style="min-width:140px"></select>
        <input id="tplDay" inputmode="numeric" placeholder="æ—¥(1-31)" style="width:110px">
        <input id="tplAmount" inputmode="numeric" placeholder="é‡‘é¡(å††)" style="width:140px">
        <input id="tplMemo" placeholder="ãƒ¡ãƒ¢" style="flex:1 1 auto">
        <label class="sub" style="display:flex; align-items:center; gap:6px"><input id="tplEst" type="checkbox">æ¦‚ç®—</label>
        <button id="addTpl" class="btn" type="button">ãƒ†ãƒ³ãƒ—ãƒ¬è¿½åŠ </button>
      </div>
      <div class="row-mid" style="margin-top:10px">
        <div class="sub" id="tplStatus"></div>
      </div>
    </div>
  </div>

  <!-- settings modal -->
  <div id="settingsModal" class="modal">
    <div class="panel">
      <div class="row-mid">
        <h3 style="margin:0">ç· æ—¥è¨­å®š</h3>
        <button id="closeSettings" class="btn ghost" type="button" style="margin-left:auto; height:auto; padding:6px 10px">é–‰ã˜ã‚‹</button>
      </div>
      <div class="row-mid" style="margin-top:8px">
        <label class="sub" for="paydayInput">ãƒ™ãƒ¼ã‚¹çµ¦æ–™æ—¥ï¼ˆ1ã€œ31ï¼‰</label>
        <input id="paydayInput" inputmode="numeric" placeholder="25 ãªã©" style="width:120px">
        <div class="sub">çµ¦æ–™æ—¥ã®ã¿ä¼‘æ—¥ãªã‚‰å‰å–¶æ¥­æ—¥ã«ç¹°ä¸Šã’ã€‚å®šä¾‹ã¯ç§»å‹•ã—ã¾ã›ã‚“ã€‚</div>
      </div>
      <div class="row-mid" style="margin-top:8px">
        <label class="sub"><input id="adjWeekends" type="checkbox" checked> åœŸæ—¥ã‚’ä¼‘æ¥­æ—¥ã¨ã—ã¦æ‰±ã†ï¼ˆçµ¦æ–™æ—¥ã®ã¿ï¼‰</label>
      </div>
      <div class="row-mid" style="margin-top:8px; align-items:flex-start">
        <div style="flex:1 1 100%">
          <label class="sub" for="holidaysInput">è¿½åŠ ã®ä¼‘æ¥­æ—¥ï¼ˆYYYY-MM-DD ã‚’ã‚«ãƒ³ãƒ or æ”¹è¡Œã§ï¼‰</label>
          <textarea id="holidaysInput" placeholder="2025-01-01, 2025-01-13&#10;2025-02-11 ..."></textarea>
        </div>
      </div>

      <!-- ãƒ†ã‚¹ãƒˆæ—¥ï¼ˆä»»æ„ï¼‰ -->
      <div class="row-mid" style="margin-top:8px">
        <label class="sub" for="mockTodayInput">ãƒ†ã‚¹ãƒˆæ—¥ï¼ˆä»»æ„, YYYY-MM-DDï¼‰</label>
        <input id="mockTodayInput" placeholder="ä¾‹: 2025-11-20" style="width:160px">
        <button id="applyMockToday" class="btn ghost" type="button">åæ˜ </button>
        <button id="clearMockToday" class="btn ghost" type="button">è§£é™¤</button>
      </div>

      <div class="row-mid" style="margin-top:10px">
        <button id="saveSettings" class="btn" type="button">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- Supabaseï¼ˆUMDç‰ˆï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  
  <script>
  (async () => {
    // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿ç¢ºèª
    if (!window.supabase || !window.supabase.createClient) {
      const msg = "Supabaseãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­è¾¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚„åºƒå‘Šãƒ–ãƒ­ãƒƒã‚«ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
      console.warn(msg);
      const m = document.getElementById("syncMsg");
      if (m) m.textContent = msg;
      ["sSignup","sLogin","sLogout","sResetPw"].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.onclick = () => alert(msg);
      });
      return;
    }

    // ã‚ãªãŸã® Supabase å€¤
    const SUPABASE_URL = "https://jwetmkoemtzonzvcsawn.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3ZXRta29lbXR6b256dmNzYXduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzNzgwMzcsImV4cCI6MjA3Mzk1NDAzN30.Llt8iNr9dx3PmR6jInNlGSZnI3zIln4LLyR1dge7fN0";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ====== ã‚µã‚¤ãƒ¬ãƒ³ãƒˆè‡ªå‹•ä¿å­˜ ======
    let dirty = false;
    let autosaveTimer = null;

    async function currentUser() {
      const { data:{ user } } = await sb.auth.getUser();
      return user || null;
    }
    async function cloudSaveSilent() {
      const user = await currentUser();
      if (!user) return;
      const payload = packAll();
      try {
        await sb.from("app_states").upsert({
          user_id: user.id,
          payload,
          updated_at: new Date().toISOString()
        });
        dirty = false;
      } catch (_) {}
    }
    function markDirty() {
      dirty = true;
      if (autosaveTimer) return;
      autosaveTimer = setTimeout(async () => {
        autosaveTimer = null;
        if (dirty) await cloudSaveSilent();
      }, 5000);
    }
    window.markDirty = markDirty;

    async function flushBeforeHide() {
      if (!dirty) return;
      try { await cloudSaveSilent(); } catch(_) {}
      if (dirty) {
        const user = await currentUser();
        if (!user) return;
        const url = `${SUPABASE_URL}/rest/v1/app_states?on_conflict=user_id`;
        const body = JSON.stringify({
          user_id: user.id,
          payload: packAll(),
          updated_at: new Date().toISOString()
        });
        fetch(url, {
          method: "POST",
          headers: {
            "apikey": SUPABASE_ANON_KEY,
            "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
            "Content-Type": "application/json",
            "Prefer": "resolution=merge-duplicates"
          },
          body,
          keepalive: true
        });
        dirty = false;
      }
    }
    document.addEventListener("visibilitychange", () => { if (document.hidden) flushBeforeHide(); });
    window.addEventListener("pagehide", flushBeforeHide);

    const _q = (id)=>document.getElementById(id);
    function on(id, handler) {
      const el = _q(id);
      if (!el) return;
      el.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); handler(e); }, { passive:false });
      el.addEventListener('keydown', (e)=>{ if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); handler(e); }});
    }
    function syncSetMsg(m){ _q("syncMsg").textContent = m || ""; }

    on("sSignup", async ()=> {
      const { error } = await sb.auth.signUp({ email:_q("sEmail").value, password:_q("sPw").value });
      syncSetMsg(error ? "ç™»éŒ²å¤±æ•—: "+error.message : "ç™»éŒ²OKã€‚ç¶šã‘ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
      refreshSyncUI();
    });

    // ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆå¤šé‡é˜²æ­¢ï¼‰
    const sLoginEl = _q("sLogin");
    let loginBusy = false;

    async function handleLogin(e) {
      if (e) { e.preventDefault(); e.stopPropagation(); }
      if (loginBusy) return;
      loginBusy = true;
      sLoginEl.disabled = true;
      sLoginEl.setAttribute("aria-busy","true");

      const email = (_q("sEmail").value || "").trim();
      const password = _q("sPw").value || "";
      if (!email || !password) {
        syncSetMsg("ãƒ¡ãƒ¼ãƒ«ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        loginBusy = false;
        sLoginEl.disabled = false;
        sLoginEl.removeAttribute("aria-busy");
        return;
      }

      syncSetMsg("ãƒ­ã‚°ã‚¤ãƒ³ä¸­â€¦");
      const loginPromise = sb.auth.signInWithPassword({ email, password });
      const timeout = new Promise((_, rej) => setTimeout(() => rej(new Error("timeout")), 20000));

      try {
        const { data, error } = await Promise.race([loginPromise, timeout]);
        if (error) {
          syncSetMsg("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: " + error.message);
        } else {
          syncSetMsg("ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ");
          await refreshSyncUI();
        }
      } catch (err) {
        const msg = String(err?.message || err);
        if (msg.includes("timeout")) {
          syncSetMsg("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: å¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆå›ç·šãƒ»æ‹¡å¼µæ©Ÿèƒ½ãƒ»ä¼šç¤¾ã®ãƒãƒƒãƒˆåˆ¶é™ã‚’ç¢ºèªï¼‰");
        } else if (msg.includes("CORS")) {
          syncSetMsg("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ãƒ–ãƒ©ã‚¦ã‚¶ãŒé€šä¿¡ã‚’ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆURLè¨­å®šã‚’ç¢ºèªï¼‰");
        } else if (msg.includes("ERR_BLOCKED_BY_CLIENT")) {
          syncSetMsg("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: æ‹¡å¼µæ©Ÿèƒ½ãŒé€šä¿¡ã‚’åœæ­¢ï¼ˆã‚¢ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ä¸€æ™‚åœæ­¢ï¼‰");
        } else {
          syncSetMsg("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: " + msg);
        }
      } finally {
        loginBusy = false;
        sLoginEl.disabled = false;
        sLoginEl.removeAttribute("aria-busy");
      }
    }

    if (sLoginEl) {
      sLoginEl.addEventListener("pointerup", handleLogin, { passive:false });
      sLoginEl.addEventListener("click",      handleLogin, { passive:false });
      sLoginEl.addEventListener("keydown", (e) => { if (e.key === "Enter" || e.key === " ") handleLogin(e); }, { passive:false });
    }
    ["sEmail","sPw"].forEach(id=>{ _q(id)?.addEventListener("keydown", e => { if (e.key === "Enter") handleLogin(e); }); });

    on("sLogout", async ()=> {
      try { await sb.auth.signOut(); } catch(_) {}
      syncSetMsg("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ");
      setTimeout(refreshSyncUI, 50);
    });

    on("sResetPw", async ()=> {
      const email = (_q("sEmail").value || "").trim();
      if (!email) { syncSetMsg("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
      const redirectTo = location.origin + location.pathname + "#pw-reset";
      const { error } = await sb.auth.resetPasswordForEmail(email, { redirectTo });
      syncSetMsg(error ? ("ãƒªã‚»ãƒƒãƒˆé€ä¿¡å¤±æ•—: " + error.message) : "ãƒªã‚»ãƒƒãƒˆç”¨ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ");
    });

    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†è¨­å®šãƒ‘ãƒãƒ«
    function ensurePwResetPanel() {
      let panel = document.getElementById("pwResetPanel");
      if (panel) return panel;

      panel = document.createElement("div");
      panel.id = "pwResetPanel";
      panel.className = "card";
      panel.style.marginTop = "8px";

      panel.innerHTML = `
        <div class="sub" style="margin-bottom:8px">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
        <div class="row">
          <div class="pwd-wrap" style="flex:1 1 260px">
            <input id="newPw1" type="password" placeholder="æ–°ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
            <button type="button"
                    class="btn ghost eye"
                    data-eye="newPw1"
                    aria-pressed="false"
                    aria-label="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¡¨ç¤º">ğŸ‘</button>
          </div>
          <div class="pwd-wrap" style="flex:1 1 260px">
            <input id="newPw2" type="password" placeholder="æ–°ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰">
            <button type="button"
                    class="btn ghost eye"
                    data-eye="newPw2"
                    aria-pressed="false"
                    aria-label="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¡¨ç¤º">ğŸ‘</button>
          </div>
          <button id="applyNewPw" class="btn" type="button">æ›´æ–°</button>
          <button id="cancelNewPw" class="btn ghost" type="button">é–‰ã˜ã‚‹</button>
        </div>
        <div class="sub" id="pwResetMsg" style="margin-top:6px"></div>
      `;

      installEyeToggleFor('newPw1');
      installEyeToggleFor('newPw2');

      const authArea = document.getElementById("authArea");
      authArea?.appendChild(panel);

      const msg = (t)=> document.getElementById("pwResetMsg").textContent = t || "";

      document.getElementById("applyNewPw").onclick = async () => {
        const a = (document.getElementById("newPw1").value || "");
        const b = (document.getElementById("newPw2").value || "");
        if (!a || a.length < 8) { msg("8æ–‡å­—ä»¥ä¸Šã‚’æ¨å¥¨ã—ã¾ã™"); return; }
        if (a !== b) { msg("ç¢ºèªç”¨ã¨ä¸€è‡´ã—ã¾ã›ã‚“"); return; }
        try {
          const { error } = await sb.auth.updateUser({ password: a });
          if (error) msg("æ›´æ–°å¤±æ•—: " + error.message);
          else {
            msg("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„ã€‚");
            panel.remove();
            if (location.hash === "#pw-reset") history.replaceState(null, "", location.pathname);
          }
        } catch (e) {
          msg("æ›´æ–°å¤±æ•—: " + (e?.message || e));
        }
      };

      document.getElementById("cancelNewPw").onclick = () => {
        panel.remove();
        if (location.hash === "#pw-reset") history.replaceState(null, "", location.pathname);
      };

      return panel;
    }

    sb.auth.onAuthStateChange(async (event) => {
      if (event === "PASSWORD_RECOVERY") ensurePwResetPanel();
    });
    if (location.hash === "#pw-reset") ensurePwResetPanel();
    if (location.hash && /type=recovery/i.test(location.hash)) ensurePwResetPanel();

    // pack/unpack
    function packAll(){
      try{
        return {
          cards, entries, templates,
          paydayBase, adjustWeekends,
          holidays,
          holidaysUser: load(KEY_HOLIDAYS_USER, [])
        };
      }catch(e){ return null; }
    }
    function unpackAll(obj){
      if(!obj) return;
      autosavePaused = true;
      if(Array.isArray(obj.cards)) cards=obj.cards;
      if(obj.entries && typeof obj.entries==="object") entries=obj.entries;
      if(Array.isArray(obj.templates)) templates=obj.templates;
      if(typeof obj.paydayBase==="number") paydayBase=obj.paydayBase|0;
      if(typeof obj.adjustWeekends==="boolean") adjustWeekends=obj.adjustWeekends;

      if(Array.isArray(obj.holidays)) holidays = obj.holidays;
      const holidaysUser = Array.isArray(obj.holidaysUser) ? obj.holidaysUser : load(KEY_HOLIDAYS_USER, []);

      save(KEYS.CARDS,cards); save(KEYS.ENTRIES,entries); save(KEYS_TPL.LIST,templates);
      save(KEY_PAYDAY,paydayBase); save(KEY_ADJ_WK,adjustWeekends);
      saveSilent(KEY_HOLIDAYS_USER, holidaysUser);

      holidays = Array.from(new Set([...(holidays||[]), ...holidaysUser])).sort();
      save(KEY_HOLIDAYS, holidays);

      autosavePaused = false;
      render();
    }

    _q("cloudSave").onclick = async ()=>{
      try{
        const { data:{ user } } = await sb.auth.getUser();
        if(!user) throw new Error("æœªãƒ­ã‚°ã‚¤ãƒ³");
        syncSetMsg("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­â€¦");
        const payload = packAll();
        const { error } = await sb.from("app_states").upsert({ user_id:user.id, payload, updated_at:new Date().toISOString() });
        if(error) throw error;
        syncSetMsg("ã‚¯ãƒ©ã‚¦ãƒ‰ä¿å­˜ã—ã¾ã—ãŸ âœ…");
      }catch(e){ syncSetMsg("ä¿å­˜å¤±æ•—: "+e.message); }
    };

    _q("cloudLoad").onclick = async ()=>{
      try{
        const { data:{ user } } = await sb.auth.getUser();
        if(!user) throw new Error("æœªãƒ­ã‚°ã‚¤ãƒ³");
        syncSetMsg("ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­â€¦");
        const { data, error } = await sb.from("app_states").select("payload, updated_at").eq("user_id", user.id).maybeSingle();
        if(error) throw error;
        if(!data){ syncSetMsg("ã‚µãƒ¼ãƒãƒ¼ä¸Šã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
        unpackAll(data.payload);
        syncSetMsg("ã‚¯ãƒ©ã‚¦ãƒ‰èª­è¾¼OK âœ…");
      }catch(e){ syncSetMsg("èª­è¾¼å¤±æ•—: "+e.message); }
    };

    refreshSyncUI();
    sb.auth.onAuthStateChange(()=>refreshSyncUI());

    installEyeToggleFor('sPw');
  

    async function refreshSyncUI(){
      const { data:{ session } } = await sb.auth.getSession();
      const user = session?.user || null;
      _q("authArea").style.display = user ? "none" : "block";
      _q("syncArea").style.display = user ? "flex" : "none";
      _q("sWho").textContent = user?.email || "";

      setTimeout(async ()=>{
        const { data:{ session } } = await sb.auth.getSession();
        const user2 = session?.user || null;
        _q("authArea").style.display = user2 ? "none" : "block";
        _q("syncArea").style.display = user2 ? "flex" : "none";
        _q("sWho").textContent = user2?.email || "";
      }, 120);

      const pwPanel = document.getElementById("pwResetPanel");
      if (user && pwPanel) {
        pwPanel.remove();
        if (/type=recovery|pw-reset/i.test(location.hash)) {
          history.replaceState(null, "", location.pathname);
        }
      }
    }
  })();
  </script>

  <script>
  /* utils */
  const $ = s=>document.querySelector(s);
  const fmtJPY = n=>'Â¥'+Number(n||0).toLocaleString('ja-JP');
  const pad2 = n=>String(n).padStart(2,'0');
  const yyyymm = d=>`${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
  const ymd = d=>`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;

  /* ==== mock today (UIãªã—ãƒ»é…å¸ƒç”¨) ==== */
  const MOCK_KEY = 'cb_mock_today_v1';
  const readMock = ()=> {
    const s = (localStorage.getItem(MOCK_KEY)||'').trim();
    return /^\d{4}-\d{2}-\d{2}$/.test(s) ? s : null;
  };
  // ã‚¢ãƒ—ãƒªå…±é€šã®ã€Œä»Šã€
  const now = ()=> {
    const s = readMock();
    return s ? new Date(s+'T12:00:00') : new Date();
  };
  // ä»Šæ—¥
  const todayStr = ()=> ymd(now());
  // ?mock=YYYY-MM-DD ã§ã‚»ãƒƒãƒˆ
  (function(){
    const m = location.search.match(/[?&]mock=(\d{4}-\d{2}-\d{2})/);
    if (m) localStorage.setItem(MOCK_KEY, m[1]);
  })();

  const toHalf = s => s.replace(/[ï¼-ï½]/g, ch => String.fromCharCode(ch.charCodeAt(0)-0xFEE0));
  const toNumber = s => { if (s==null) return NaN; s = toHalf(String(s)).replace(/[^\d.\-]/g,''); if (s===''||s==='-'||s==='.'||s==='-.') return NaN; return Number(s); };
  const uuid = ()=> ('u_'+Date.now().toString(36)+Math.random().toString(36).slice(2));
  const clampDay = (y,m,day)=> { const last=new Date(y,m,0).getDate(); return Math.min(Math.max(1, day|0), last); };
  const isWeekend = d => d.getDay()===0 || d.getDay()===6;
  const startOfDay = d => { const x=new Date(d); x.setHours(0,0,0,0); return x; };
  const endOfDay   = d => { const x=new Date(d); x.setHours(23,59,59,999); return x; };
  const daysBetween = (a,b)=> Math.floor((startOfDay(b)-startOfDay(a))/86400000);

  /* storage keys */
  const KEYS = { CARDS:'cb_cards_local_v1', ENTRIES:'cb_entries_local_v1' };
  const KEYS_TPL = { LIST:'cb_templates_v1' };
  const KEY_PAYDAY = 'cb_payday_base_v1';
  const KEY_ADJ_WK = 'cb_adjust_weekends_v1';
  const KEY_HOLIDAYS = 'cb_holidays_v1';
  const KEY_HOLIDAYS_LAST = 'cb_holidays_last_updated';
  const KEY_HOLIDAYS_USER = 'cb_holidays_user_extra_v1';

  const load=(k,fb)=>{ try{ return JSON.parse(localStorage.getItem(k)) ?? fb }catch{ return fb } };

  let autosavePaused = false;

  const save=(k,v)=>{
    try{
      localStorage.setItem(k, JSON.stringify(v));
      if (!autosavePaused && typeof window.markDirty === 'function') window.markDirty();
      tick('ä¿å­˜ã—ã¾ã—ãŸ');
    }catch(e){
      tick('ä¿å­˜å¤±æ•—');
    }
  };
  function saveSilent(k, v){
    try{
      autosavePaused = true;
      localStorage.setItem(k, JSON.stringify(v));
    } finally {
      autosavePaused = false;
    }
  }

  /* state */
  let cards = load(KEYS.CARDS, []);
  let entries = load(KEYS.ENTRIES, {});
  let templates = load(KEYS_TPL.LIST, []);
  let editingRef = null;
  let legacyCycle = load('cb_cycle_start_day_v1', null);
  let paydayBase = load(KEY_PAYDAY, legacyCycle!=null ? legacyCycle : 1);
  let adjustWeekends = load(KEY_ADJ_WK, true);
  let holidays = load(KEY_HOLIDAYS, []);

  // ç¥æ—¥ICSã‚’è‡ªå‹•å–å¾—ï¼ˆGitHub Pagesé…ä¿¡ã¯CORSã§ã‚¹ã‚­ãƒƒãƒ—ï¼‰
  async function autoUpdateJapanHolidays() {
    try {
      const last = Number(localStorage.getItem(KEY_HOLIDAYS_LAST) || 0);
      if (Date.now() - last < 7*24*60*60*1000) {
        console.log("ç¥æ—¥æ›´æ–°ã‚¹ã‚­ãƒƒãƒ—ï¼ˆ7æ—¥ä»¥å†…ï¼‰");
        return;
      }

      if (location.hostname.endsWith("github.io")) {
        console.log("ç¥æ—¥æ›´æ–°ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆCORSå›é¿ï¼‰ã€‚å¿…è¦ãªã‚‰ Edge Function/JSON ã«åˆ‡æ›¿ãˆã¦ãã ã•ã„ã€‚");
        localStorage.setItem(KEY_HOLIDAYS_LAST, String(Date.now()));
        return;
      }

      const url = "https://calendar.google.com/calendar/ical/ja.japanese%23holiday%40group.v.calendar.google.com/public/basic.ics";
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error("ç¥æ—¥ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å–å¾—å¤±æ•—");
      const text = await res.text();

      const dates = [];
      text.split("BEGIN:VEVENT").slice(1).forEach(block => {
        const m = block.match(/DTSTART;?VALUE=DATE:(\d{8})/);
        if (m) dates.push(`${m[1].slice(0,4)}-${m[1].slice(4,6)}-${m[1].slice(6,8)}`);
      });
      const uniq = Array.from(new Set(dates)).sort();

      const prev = load(KEY_HOLIDAYS, []);
      const changed = JSON.stringify(prev) !== JSON.stringify(uniq);
      if (changed) {
        holidays = uniq;
        saveSilent(KEY_HOLIDAYS, holidays);
        render();
        console.log(`ç¥æ—¥ã‚’è‡ªå‹•æ›´æ–°: ${holidays.length} ä»¶`);
      } else {
        console.log("ç¥æ—¥ã¯æœ€æ–°ã§ã™ï¼ˆæ›´æ–°ãªã—ï¼‰");
      }

      localStorage.setItem(KEY_HOLIDAYS_LAST, String(Date.now()));
    } catch (e) {
      console.warn("ç¥æ—¥è‡ªå‹•æ›´æ–°ã‚¨ãƒ©ãƒ¼:", e);
    }
  }

  /* elements */
  const monthEl=$('#month'), periodRangeEl=$('#periodRange');
  const usedTotalEl=$('#usedTotal'), remainTotalEl=$('#remainTotal'), barTotalEl=$('#barTotal');
  const cardsSummaryEl=$('#cardsSummary'), cardSelectEl=$('#cardSelect'), filterCardEl=$('#filterCard');
  const dateEl=$('#date'), amountEl=$('#amount'), memoEl=$('#memo'), estimatedEl=$('#estimated');
  const listEl=$('#list'), sumFooterEl=$('#sumFooter'), statusEl=$('#status');
  const addBtn=$('#add'), updateBtn=$('#update'), cancelEditBtn=$('#cancelEdit'), clearFormBtn=$('#clearForm');
  const exportCsvBtn=$('#exportCsv'), backupBtn=$('#backup'), restoreInput=$('#restore'), gotoTodayBtn=$('#gotoToday');

  const manageCardsBtn=$('#manageCards'), cardModal=$('#cardModal'), closeCardModalBtn=$('#closeCardModal');
  const cardListEl=$('#cardList'), newCardNameEl=$('#newCardName'), newCardTargetEl=$('#newCardTarget'), resetTargetsBtn=$('#resetTargets');

  const manageTemplatesBtn=$('#manageTemplates'), tplModal=$('#tplModal'), closeTplModalBtn=$('#closeTplModal');
  const tplListEl=$('#tplList'), tplCardEl=$('#tplCard'), tplDayEl=$('#tplDay'), tplAmountEl=$('#tplAmount'), tplMemoEl=$('#tplMemo'), tplEstEl=$('#tplEst');
  const tplStatusEl=$('#tplStatus');

  const settingsModal=$('#settingsModal'), openSettingsBtn=$('#openSettings'), closeSettingsBtn=$('#closeSettings');
  const paydayInput=$('#paydayInput'), adjWeekendsEl=$('#adjWeekends'), holidaysInput=$('#holidaysInput');
  const saveSettingsBtn=$('#saveSettings');

  /* payday counter elements */
  const pdEtaEl = $('#pdEta'), pdBarEl = $('#pdBar'), pdRangeEl = $('#pdRange');
  const pdBadgeBase = $('#pdBadgeBase'), pdBadgePrev = $('#pdBadgePrev'), pdBadgeThis = $('#pdBadgeThis'), pdBadgeDays = $('#pdBadgeDays'), pdBadgePct = $('#pdBadgePct');

  /* helpers */
  const tick = (m)=>{ statusEl.textContent=m; setTimeout(()=>statusEl.textContent='â€”',1200); };
  const ensureDefaultCard=()=>{ if(cards.length===0){ cards=[{id:uuid(),name:'ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰',target:0}]; save(KEYS.CARDS,cards);} };
  const getMonthKey=()=> monthEl.value || yyyymm(now());
  const monthEntries=(key)=> entries[key] || [];
  const setMonthEntries=(key,arr)=>{ entries[key]=arr; save(KEYS.ENTRIES,entries); render(); };
  const totalTarget=()=> cards.reduce((s,c)=> s+(+c.target||0),0);

  /* business days and payday (templates are NOT adjusted) */
  function holidaySet(){ const set = new Set(); (holidays||[]).forEach(d=>{ if(typeof d==='string' && d.length>=10) set.add(d.slice(0,10)); }); return set; }
  function isHolidayDate(d, set){ return (adjustWeekends && isWeekend(d)) || set.has(ymd(d)); }
  function adjustedPayday(y, m){
    const base = new Date(y, m-1, clampDay(y,m,paydayBase));
    const set = holidaySet();
    while(isHolidayDate(base, set)){ base.setDate(base.getDate()-1); }
    return startOfDay(base);
  }

  /* period (end month anchored by next payday) */
  function periodOf(ym){
    const [y,m]=ym.split('-').map(Number);
    let py=y, pm=m-1; if(pm<1){ pm=12; py--; }
    const start = adjustedPayday(py, pm);
    const endExclusive = adjustedPayday(y, m);
    const end = new Date(endExclusive.getTime()-86400000);
    return {start, end, endExclusive};
  }
  function anchorForDate(d){
    const y=d.getFullYear(), m=d.getMonth()+1;
    const endExclusive = adjustedPayday(y, m);
    if(startOfDay(d) >= endExclusive){
      let nm=m+1, ny=y; if(nm>12){ nm=1; ny++; }
      return `${ny}-${pad2(nm)}`;
    }
    return `${y}-${pad2(m)}`;
  }
  function updatePeriodLabel(){
    const {start, end} = periodOf(getMonthKey());
    const p2=n=>String(n).padStart(2,'0');
    const f=d=>`${d.getFullYear()}-${p2(d.getMonth()+1)}-${p2(d.getDate())}`;
    periodRangeEl.textContent = `æœŸé–“: ${f(start)} ã€œ ${f(end)}ï¼ˆãƒ™ãƒ¼ã‚¹çµ¦æ–™æ—¥: ${paydayBase}æ—¥ï¼çµ¦æ–™æ—¥ã¯ä¼‘æ¥­æ—¥ãªã‚‰å‰å–¶æ¥­æ—¥ã«èª¿æ•´ã€‚å®šä¾‹ã¯ç§»å‹•ã—ã¾ã›ã‚“ï¼‰`;
  }

  /* entries in period */
  function entriesForPeriod(ym){
    const {start, end} = periodOf(ym);
    const keys = new Set([ yyyymm(start), yyyymm(end) ]);
    let rows = [];
    keys.forEach(k=>{
      (entries[k]||[]).forEach((r,idx)=>{
        const d=new Date(r.date);
        if(d>=start && d<=end) rows.push({...r, srcKey:k, srcIdx:idx});
      });
    });
    rows.sort((a,b)=> (a.date||'').localeCompare(b.date||'') || (a.memo||'').localeCompare(b.memo||'')); 
    return rows;
  }
  const sumByCardInPeriod=(ym,id)=> entriesForPeriod(ym).filter(r=>r.cardId===id).reduce((s,r)=>s+(+r.amount||0),0);
  const sumAllInPeriod=(ym)=> entriesForPeriod(ym).reduce((s,r)=>s+(+r.amount||0),0);

  /* templates (NO weekday adjustment) */
  function renderTplSelectorsFromCards(){ tplCardEl.innerHTML=''; cards.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=c.name; tplCardEl.appendChild(o); }); }
  function renderTplList(){
    tplListEl.innerHTML=''; templates.forEach(t=>{
      const c = cards.find(x=>x.id===t.cardId);
      const li=document.createElement('li');
      li.style.cssText='padding:8px 0; border-top:1px solid #eef2ff; display:flex; gap:8px; align-items:center; flex-wrap:wrap;';
      li.innerHTML = `<div class="sub">[${c?c.name:'â€”'}] æ¯æœˆ${t.day}æ—¥ / ${fmtJPY(t.amount)} / ${t.memo||''} ${t.est?'<span class="chip">æ¦‚ç®—</span>':''}</div>
                      <button data-del-tpl="${t.id}" class="btn ghost" type="button" style="height:auto; padding:6px 10px; font-size:12px">å‰Šé™¤</button>`;
      tplListEl.appendChild(li);
    });
  }
  function dateInPeriodForTpl(ym, day){
    const {start, end} = periodOf(ym);
    const ay=end.getFullYear(), am=end.getMonth()+1;
    const candA = new Date(ay, am-1, clampDay(ay, am, day));
    if(candA>=start && candA<=end) return candA;
    const sy=start.getFullYear(), sm=start.getMonth()+1;
    const candS = new Date(sy, sm-1, clampDay(sy, sm, day));
    if(candS>=start && candS<=end) return candS;
    return end;
  }

  /* æœªæ¥ï¼ˆå½“æœˆã‚’å«ã‚€ï¼‰ã ã‘é©ç”¨ã€‚å®Œå…¨ã«éå»ã®æœŸé–“ã¯é©ç”¨ã—ãªã„ */
  function applyTemplatesForMonth(ym){
    const { start, end } = periodOf(ym);
    const today = startOfDay(now());
    if (end < today) return 0;

    const periodRows = entriesForPeriod(ym);
    let added = 0;

    templates.forEach(t => {
      const target = dateInPeriodForTpl(ym, t.day);
      const dateStr = ymd(target);

      const exists = periodRows.some(r =>
        r.cardId === t.cardId &&
        r.date   === dateStr &&
        +r.amount === +t.amount &&
        (r.memo || '') === (t.memo || '') &&
        !!r.est === !!t.est
      );

      if (!exists) {
        const key = dateStr.slice(0,7);
        const arr = monthEntries(key).slice();
        arr.push({ cardId:t.cardId, tplId:t.id, date:dateStr, amount:+t.amount, memo:t.memo||'', est:!!t.est });
        entries[key] = arr;
        added++;
      }
    });

    if (added > 0) { save(KEYS.ENTRIES, entries); render(); }
    return added;
  }

  /* å…ˆèª­ã¿ï¼ˆå‰æœˆãƒ»å½“æœˆãƒ»ç¿Œæœˆï¼‰ */
  function ymAdd(ym, delta){ const d = new Date(ym + '-01'); d.setMonth(d.getMonth() + delta); return yyyymm(d); }
  function preapplyNeighbors(ym){ [ymAdd(ym,-1), ym, ymAdd(ym,1)].forEach(k => applyTemplatesForMonth(k)); }

  /* payday counter */
  function currentPayPeriodForCounter(today=now()){
    const y=today.getFullYear(), m=today.getMonth()+1;
    const thisPay = adjustedPayday(y, m);
    if(startOfDay(today) >= startOfDay(thisPay)){
      const nm = m===12?1:m+1, ny = m===12?y+1:y;
      return { prevPay: thisPay, thisPay: adjustedPayday(ny, nm) };
    }else{
      const pm = m===1?12:m-1, py = m===1?y-1:y;
      return { prevPay: adjustedPayday(py, pm), thisPay };
    }
  }
  function renderPaydayCounter(){
    const { prevPay, thisPay } = currentPayPeriodForCounter(now());
    const totalDays = Math.max(1, daysBetween(prevPay, thisPay));
    const elapsed = Math.max(0, Math.min(totalDays, daysBetween(prevPay, now())));
    const remaining = Math.max(0, totalDays - elapsed);
    const pct = Math.round((elapsed/totalDays)*100);
    const isToday = ymd(now()) === ymd(thisPay);

    pdEtaEl.textContent = isToday ? 'æœ¬æ—¥ãŒçµ¦æ–™æ—¥ã§ã™ï¼' : 'ã‚ã¨ ' + remaining + ' æ—¥';
    pdEtaEl.classList.toggle('ok', isToday);
    pdBarEl.style.width = pct + '%';
    pdBarEl.style.background = remaining<=3 ? (remaining===0?'var(--ok)':'var(--warn2)') : 'var(--accent)';

    const f = d => d.getFullYear() + '/' + (d.getMonth()+1) + '/' + d.getDate();
    pdRangeEl.textContent = 'æœŸé–“ï¼š' + f(prevPay) + ' ã€œ ' + f(thisPay) + 'ï¼ˆå…¨' + totalDays + 'æ—¥ãƒ»é€²æ—' + pct + '%ï¼‰';

    pdBadgeBase.textContent = 'ãƒ™ãƒ¼ã‚¹: ' + paydayBase + 'æ—¥';
    pdBadgePrev.textContent = 'å‰å›: ' + f(prevPay);
    pdBadgeThis.textContent = 'ä»Šå›: ' + f(thisPay);
    pdBadgeDays.textContent = 'å…¨: ' + totalDays + 'æ—¥';
    pdBadgePct.textContent = 'é€²æ—: ' + pct + '%';
  }

  /* render */
  function renderCardsSummary(){
    const ym = getMonthKey(); cardsSummaryEl.innerHTML='';
    cards.forEach(c=>{
      const used = sumByCardInPeriod(ym, c.id);
      const tgt = +c.target||0;
      const remain = Math.max(tgt-used,0);
      const pct = tgt>0 ? Math.min(Math.round(used/tgt*100),100) : 0;
      const d=document.createElement('div'); d.className='card';
      d.innerHTML=`
        <div class="row" style="align-items:center">
          <div style="font-weight:600">${c.name}</div>
          <span class="sub" style="margin-left:auto">ç›®æ¨™: <b>${fmtJPY(tgt)}</b> / ä½¿ç”¨: <b>${fmtJPY(used)}</b> / æ®‹ã‚Š: <b>${tgt?fmtJPY(remain):'ç›®æ¨™æœªè¨­å®š'}</b></span>
          <button data-edit-card="${c.id}" class="btn ghost" type="button" style="height:auto; padding:6px 10px; font-size:12px">ç·¨é›†</button>
          <button data-del-card="${c.id}" class="btn ghost" type="button" style="height:auto; padding:6px 10px; font-size:12px">å‰Šé™¤</button>
        </div>
        <div class="bar" style="margin-top:8px"><div style="width:${pct}%; background:${used>tgt?'var(--warn)':'var(--accent)'}"></div></div>`;
      cardsSummaryEl.appendChild(d);
    });
  }
  function renderTopSummary(){
    const ym = getMonthKey();
    const used = sumAllInPeriod(ym);
    const tgt = totalTarget();
    usedTotalEl.textContent = fmtJPY(used);
    sumFooterEl.textContent = fmtJPY(used);
    if(tgt>0){
      const remain = Math.max(tgt-used,0);
      remainTotalEl.textContent = fmtJPY(remain);
      const pct = Math.min(Math.round(used/tgt*100),100);
      barTotalEl.style.width = pct+'%';
      barTotalEl.style.background = (used>tgt?'var(--warn)':'var(--accent)');
    }else{
      remainTotalEl.textContent = 'ç›®æ¨™æœªè¨­å®š';
      barTotalEl.style.width='0%'; barTotalEl.style.background='var(--accent)';
    }
    updatePeriodLabel();
  }
  function renderCardSelectors(){
    cardSelectEl.innerHTML=''; cards.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=c.name; cardSelectEl.appendChild(o); });
    const cur=filterCardEl.value; filterCardEl.innerHTML='<option value="">ï¼ˆã™ã¹ã¦ã®ã‚«ãƒ¼ãƒ‰ï¼‰</option>';
    cards.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=c.name; filterCardEl.appendChild(o); });
    if(cur && cards.some(c=>c.id===cur)) filterCardEl.value=cur;
  }
  function renderList(){
    const ym = getMonthKey();
    const filter = filterCardEl.value;
    const rows = entriesForPeriod(ym).filter(r=>!filter || r.cardId===filter);
    listEl.innerHTML='';
    rows.forEach(r=>{
      const card=cards.find(c=>c.id===r.cardId); const badge=r.est?'<span class="chip">æ¦‚ç®—</span>':'';
      const li=document.createElement('li');
      li.innerHTML=`<div class="date">${r.date||''}</div>
        <div class="amt">${fmtJPY(r.amount||0)} ${badge}</div>
        <div style="font-size:12px; color:var(--muted); flex:1">ã‚«ãƒ¼ãƒ‰: ${card?card.name:'â€”'} ï¼ ${r.memo||''}</div>
        <div style="display:flex; gap:6px">
          <button data-edit='${r.srcKey}:${r.srcIdx}' class="btn ghost" type="button" style="height:auto; padding:6px 10px; font-size:12px">ç·¨é›†</button>
          <button data-del='${r.srcKey}:${r.srcIdx}' class="btn ghost" type="button" style="height:auto; padding:6px 10px; font-size:12px">å‰Šé™¤</button>
        </div>`;
      listEl.appendChild(li);
    });
  }
  function render(){
    ensureDefaultCard();
    renderTopSummary(); renderCardsSummary(); renderCardSelectors(); renderList();
    renderPaydayCounter();
    addBtn.classList.remove('hidden'); updateBtn.classList.add('hidden'); cancelEditBtn.classList.add('hidden');
  }

  /* init */
  (function init(){
    if(legacyCycle!=null){ try{ localStorage.removeItem('cb_cycle_start_day_v1'); }catch{} }
    monthEl.value = anchorForDate(now());
    dateEl.value = todayStr();
    ensureDefaultCard();
    applyTemplatesForMonth(getMonthKey());
    render();
    preapplyNeighbors(getMonthKey());
    setInterval(()=> renderPaydayCounter(), 3600*1000);

    // èµ·å‹•æ™‚ï¼šç¥æ—¥è‡ªå‹•æ›´æ–° â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ åˆ†ã¨åˆä½“ â†’ åæ˜ 
    autoUpdateJapanHolidays().finally(()=>{
      const ics = load(KEY_HOLIDAYS, []);
      const userExtra = load(KEY_HOLIDAYS_USER, []);
      holidays = Array.from(new Set([...ics, ...userExtra])).sort();
      saveSilent(KEY_HOLIDAYS, holidays);
      render();
    });
  })();

  /* events: month nav */
  monthEl.addEventListener('change', ()=>{
    editingRef=null;
    applyTemplatesForMonth(getMonthKey());
    preapplyNeighbors(getMonthKey());
    render();
  });
  filterCardEl.addEventListener('change', ()=> render());
  $('#prevMonth').addEventListener('click', ()=>{
    const d = new Date((getMonthKey()) + "-01"); d.setMonth(d.getMonth()-1);
    monthEl.value = yyyymm(d);
    applyTemplatesForMonth(getMonthKey());
    preapplyNeighbors(getMonthKey());
    render();
  });
  $('#nextMonth').addEventListener('click', ()=>{
    const d = new Date((getMonthKey()) + "-01"); d.setMonth(d.getMonth()+1);
    monthEl.value = yyyymm(d);
    applyTemplatesForMonth(getMonthKey());
    preapplyNeighbors(getMonthKey());
    render();
  });
  gotoTodayBtn.addEventListener('click', ()=>{
    monthEl.value=anchorForDate(now());
    applyTemplatesForMonth(getMonthKey());
    preapplyNeighbors(getMonthKey());
    render();
  });

  /* cards summary edit/delete */
  cardsSummaryEl.addEventListener('click', function(e) {
    var editBtn = e.target.closest('button[data-edit-card]');
    var delBtn  = e.target.closest('button[data-del-card]');

    if (editBtn) {
      var id = editBtn.dataset.editCard;
      renderCardModal();
      cardModal.classList.add('show');
      setTimeout(function(){
        var nameInput = cardListEl.querySelector('input[data-card-name="' + id + '"]');
        if (nameInput) { nameInput.focus(); nameInput.scrollIntoView({ block: 'center', behavior: 'smooth' }); }
      }, 0);
      return;
    }

    if (delBtn) {
      var id2 = delBtn.dataset.delCard;
      var card = cards.find(function(c){ return c.id === id2; });
      if (!card) return;
      if (!confirm('ã‚«ãƒ¼ãƒ‰ã€Œ' + card.name + 'ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nâ€»æ˜ç´°ã¯æ®‹ã‚Šã¾ã™ï¼ˆã‚«ãƒ¼ãƒ‰ã®ã¿å‰Šé™¤ï¼‰')) return;

      cards = cards.filter(function(c){ return c.id !== id2; });
      save(KEYS.CARDS, cards);

      if (!cards.some(function(c){ return c.id === (cardSelectEl.value || ''); })) {
        if (cards[0]) cardSelectEl.value = cards[0].id;
      }
      render();
      tick('ã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
    }
  });

  /* add entry */
  addBtn.addEventListener('click', ()=>{
    const cardId = cardSelectEl.value || (cards[0]&&cards[0].id);
    let d = dateEl.value || todayStr();
    const a = toNumber((amountEl.value||'').trim());
    const me = (memoEl.value||'').trim();
    const est = !!estimatedEl.checked;
    if(!cardId){ tick('ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
    if(!Number.isFinite(a) || a<=0){ tick('é‡‘é¡ã‚’æ•°å€¤ã§'); return; }
    const key = d.slice(0,7);
    const rows = monthEntries(key).slice();
    rows.push({ cardId, date:d, amount:a, memo:me, est });
    setMonthEntries(key, rows);
    amountEl.value=''; memoEl.value=''; estimatedEl.checked=false;
  });

  /* list edit/delete */
  listEl.addEventListener('click', (e)=>{
    const editBtn=e.target.closest('button[data-edit]'); const delBtn=e.target.closest('button[data-del]');
    if(editBtn){
      const [srcKey, srcIdx] = editBtn.dataset.edit.split(':');
      const rows = monthEntries(srcKey);
      const r = rows[+srcIdx]; if(!r) return;
      editingRef = {srcKey, srcIdx:+srcIdx};
      cardSelectEl.value = r.cardId;
      dateEl.value = r.date || todayStr();
      amountEl.value = r.amount || '';
      memoEl.value = r.memo || '';
      estimatedEl.checked = !!r.est;
      addBtn.classList.add('hidden'); updateBtn.classList.remove('hidden'); cancelEditBtn.classList.remove('hidden');
      return;
    }
    if(delBtn){
      const [srcKey, srcIdx] = delBtn.dataset.del.split(':');
      const rows = monthEntries(srcKey).slice();
      rows.splice(+srcIdx,1);
      setMonthEntries(srcKey, rows);
    }
  });
  updateBtn.addEventListener('click', ()=>{
    if(!editingRef) return;
    const oldKey = editingRef.srcKey, oldIdx = editingRef.srcIdx;
    const rowsOld = monthEntries(oldKey).slice();
    if(!rowsOld[oldIdx]) return;

    const cardId = cardSelectEl.value || (cards[0]&&cards[0].id);
    let d = dateEl.value || todayStr();
    const a = toNumber((amountEl.value||'').trim());
    const me = (memoEl.value||'').trim();
    const est = !!estimatedEl.checked;
    if(!Number.isFinite(a) || a<=0){ tick('é‡‘é¡ã‚’æ•°å€¤ã§'); return; }

    const newRow = { cardId, date:d, amount:a, memo:me, est };
    const newKey = d.slice(0,7);
    if(newKey === oldKey){
      rowsOld[oldIdx] = newRow; setMonthEntries(oldKey, rowsOld);
    }else{
      rowsOld.splice(oldIdx,1); setMonthEntries(oldKey, rowsOld);
      const rowsNew = monthEntries(newKey).slice(); rowsNew.push(newRow); setMonthEntries(newKey, rowsNew);
    }
    editingRef=null; amountEl.value=''; memoEl.value=''; estimatedEl.checked=false;
    addBtn.classList.remove('hidden'); updateBtn.classList.add('hidden'); cancelEditBtn.classList.add('hidden');
  });
  cancelEditBtn.addEventListener('click', ()=>{ editingRef=null; amountEl.value=''; memoEl.value=''; estimatedEl.checked=false; dateEl.value=todayStr(); addBtn.classList.remove('hidden'); updateBtn.classList.add('hidden'); cancelEditBtn.classList.add('hidden'); });
  clearFormBtn.addEventListener('click', ()=>{ amountEl.value=''; memoEl.value=''; estimatedEl.checked=false; if(!dateEl.value) dateEl.value=todayStr(); });

  /* csv/backup/restore */
  exportCsvBtn.addEventListener('click', ()=>{
    const ym = getMonthKey();
    const rows = entriesForPeriod(ym);
    const csv = ['date,card,amount,memo,estimated'].concat(rows.map(r=>{
      const c=cards.find(x=>x.id===r.cardId); const memo=(r.memo||'').replaceAll('"','""');
      return `${r.date},"${c?c.name:''}",${r.amount},"${memo}",${r.est?1:0}`;
    })).join('\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`${ym}-payday${paydayBase}.csv`; a.click(); URL.revokeObjectURL(a.href);
  });
  backupBtn.addEventListener('click', ()=>{
    const data={
      cards, entries, templates,
      paydayBase, adjustWeekends,
      holidays,
      holidaysUser: load(KEY_HOLIDAYS_USER, [])
    };
    const blob=new Blob([JSON.stringify(data)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`cardBudget-backup-${Date.now()}.json`; a.click(); URL.revokeObjectURL(a.href);
  });
  restoreInput.addEventListener('change', (e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    const r=new FileReader();
    r.onload=()=>{ try{
      const o=JSON.parse(r.result);
      if(o && typeof o==='object'){
        if(Array.isArray(o.cards)) cards=o.cards;
        if(o.entries && typeof o.entries==='object') entries=o.entries;
        if(Array.isArray(o.templates)) templates=o.templates;
        if(typeof o.paydayBase==='number') paydayBase = Math.min(Math.max(1, o.paydayBase|0), 31);
        if(typeof o.adjustWeekends==='boolean') adjustWeekends = o.adjustWeekends;

        let holidaysUser = load(KEY_HOLIDAYS_USER, []);
        if(Array.isArray(o.holidays)) holidays = o.holidays.filter(s=>typeof s==='string');
        if(Array.isArray(o.holidaysUser)) holidaysUser = o.holidaysUser.filter(s=>typeof s==='string');

        save(KEYS.CARDS,cards); save(KEYS.ENTRIES,entries); save(KEYS_TPL.LIST,templates);
        save(KEY_PAYDAY, paydayBase); save(KEY_ADJ_WK, adjustWeekends);
        saveSilent(KEY_HOLIDAYS_USER, holidaysUser);

        holidays = Array.from(new Set([...(holidays||[]), ...holidaysUser])).sort();
        save(KEY_HOLIDAYS, holidays);

        render();
      }
    }catch{ tick('å¾©å…ƒã«å¤±æ•—'); } };
    r.readAsText(f);
  });

  /* card modal */
  function renderCardModal(){
    cardListEl.innerHTML=''; const ym=getMonthKey();
    cards.forEach(c=>{
      const li=document.createElement('li'); li.style.cssText='padding:8px 0; display:flex; gap:8px; align-items:center;';
      li.innerHTML=`<input data-card-name="${c.id}" style="flex:1 1 auto; padding:8px 10px; border:1px solid var(--border); border-radius:10px" value="${c.name}">
        <input data-card-target="${c.id}" style="width:140px; padding:8px 10px; border:1px solid var(--border); border-radius:10px" value="${c.target}" inputmode="numeric">
        <span class="sub">ä½¿ç”¨: ${fmtJPY(sumByCardInPeriod(ym,c.id))}</span>`;
      cardListEl.appendChild(li);
    });
  }
  manageCardsBtn.addEventListener('click', ()=>{ renderCardModal(); cardModal.classList.add('show'); });
  closeCardModalBtn.addEventListener('click', ()=> cardModal.classList.remove('show'));
  cardModal.addEventListener('click', (e)=>{ if(e.target===cardModal) cardModal.classList.remove('show'); });
  cardListEl.addEventListener('input', (e)=>{
    const nameEl=e.target.closest('input[data-card-name]'); const tgtEl=e.target.closest('input[data-card-target]');
    if(nameEl){ const id=nameEl.dataset.cardName; const c=cards.find(x=>x.id===id); if(!c) return; c.name=nameEl.value; save(KEYS.CARDS,cards); renderCardSelectors(); renderCardsSummary(); renderList(); }
    else if(tgtEl){ const id=tgtEl.dataset.cardTarget; const c=cards.find(x=>x.id===id); if(!c) return; c.target=toNumber(tgtEl.value); save(KEYS.CARDS,cards); renderTopSummary(); renderCardsSummary(); }
  });

  /* add card */
  $('#addCard').addEventListener('click', function () {
    const name = (newCardNameEl.value || '').trim();
    const tgt  = toNumber(newCardTargetEl.value || '');
    if (!name) { tick('ã‚«ãƒ¼ãƒ‰åã‚’å…¥ã‚Œã¦ãã ã•ã„'); return; }
    if (!Number.isFinite(tgt) || tgt < 0) { tick('ç›®æ¨™é¡ã¯0ä»¥ä¸Šã®æ•°å€¤ã§'); return; }

    const id = uuid();
    cards.push({ id, name, target: +tgt });
    save(KEYS.CARDS, cards);

    newCardNameEl.value = '';
    newCardTargetEl.value = '';

    renderCardModal();
    renderCardSelectors();
    renderCardsSummary();
    renderList();
    try { cardSelectEl.value = id; } catch(_) {}
    renderTplSelectorsFromCards();

    tick('ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
  });

  /* template modal events */
  manageTemplatesBtn.addEventListener('click', ()=>{ renderTplSelectorsFromCards(); renderTplList(); tplModal.classList.add('show'); });
  closeTplModalBtn.addEventListener('click', ()=> tplModal.classList.remove('show'));
  tplModal.addEventListener('click', (e)=>{ if(e.target===tplModal) tplModal.classList.remove('show'); });

  /* add template & apply + preapply neighborsï¼ˆæœªæ¥ã®ã¿ï¼‰ */
  $('#addTpl').addEventListener('click', function(){
    var cardId = tplCardEl.value;
    var day = toNumber(tplDayEl.value || '');
    var amount = toNumber(tplAmountEl.value || '');
    var memo = (tplMemoEl.value || '').trim();
    var est = !!tplEstEl.checked;

    if (!cardId) { tplStatusEl.textContent = 'ã‚«ãƒ¼ãƒ‰æœªé¸æŠ'; return; }
    if (!Number.isFinite(day) || day < 1 || day > 31) { tplStatusEl.textContent = 'æ—¥ä»˜ã¯1-31ã§'; return; }
    if (!Number.isFinite(amount) || amount <= 0) { tplStatusEl.textContent = 'é‡‘é¡ã‚’æ•°å€¤ã§'; return; }

    const newTpl = { id: uuid(), cardId: cardId, day: day|0, amount: +amount, memo: memo, est: est };
    templates.push(newTpl);
    save(KEYS_TPL.LIST, templates);

    tplDayEl.value = ''; tplAmountEl.value = ''; tplMemoEl.value = ''; tplEstEl.checked = false;
    renderTplList();

    var ym = getMonthKey();
    var addedNow = applyTemplatesForMonth(ym);
    preapplyNeighbors(ym);
    render();

    tplStatusEl.textContent = addedNow ? (addedNow + 'ä»¶ã‚’ã“ã®æœˆã«è¿½åŠ ã—ã¾ã—ãŸ') : 'ã“ã®æœˆã¸ã®è¿½åŠ ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆåŒä¸€æ˜ç´°ã‚ã‚Š or éå»æœŸé–“ï¼‰';
    setTimeout(function(){ tplStatusEl.textContent = ''; }, 1200);
  });

  /* ãƒ†ãƒ³ãƒ—ãƒ¬å‰Šé™¤ï¼šéå»ã¯æ®‹ã—ã€ä»Šæ—¥ä»¥é™ã®åŒtplIdæ˜ç´°ã ã‘å‰Šé™¤ */
  tplListEl.addEventListener('click', (e)=>{
    const del = e.target.closest('button[data-del-tpl]');
    if (!del) return;
    const id = del.dataset.delTpl;

    // 1) ãƒ†ãƒ³ãƒ—ãƒ¬è‡ªä½“ã‚’å‰Šé™¤
    templates = templates.filter(t => t.id !== id);
    save(KEYS_TPL.LIST, templates);

    // 2) ä»Šæ—¥ä»¥é™ã®ã€ãã®ãƒ†ãƒ³ãƒ—ãƒ¬ç”±æ¥ã®æ˜ç´°ã ã‘ã‚’å‰Šé™¤
    const today = startOfDay(now());
    Object.keys(entries).forEach(k => {
      const arr = entries[k] || [];
      entries[k] = arr.filter(r => {
        if (r.tplId !== id) return true;
        const d = startOfDay(new Date(r.date));
        return d < today; // ä»Šæ—¥ã‚ˆã‚Šå‰ã¯æ®‹ã™
      });
    });
    save(KEYS.ENTRIES, entries);

    renderTplList();
    render();
    tick('ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’å‰Šé™¤ã€‚éå»ã®æ˜ç´°ã¯æ®‹ã—ã€ä»Šæ—¥ä»¥é™ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
  });

  /* settings modal */
  openSettingsBtn.addEventListener('click', ()=>{
    paydayInput.value = paydayBase;
    adjWeekendsEl.checked = !!adjustWeekends;
    holidaysInput.value = (load(KEY_HOLIDAYS_USER, []) || []).join(', ');
    const mockTodayInput = document.getElementById('mockTodayInput');
    if (mockTodayInput) mockTodayInput.value = readMock() || '';
    settingsModal.classList.add('show');
  });

  // ãƒ†ã‚¹ãƒˆæ—¥UI
  const mockTodayInput = document.getElementById('mockTodayInput');
  const applyMockBtn = document.getElementById('applyMockToday');
  const clearMockBtn = document.getElementById('clearMockToday');
  if (applyMockBtn && clearMockBtn && mockTodayInput) {
    applyMockBtn.onclick = ()=>{
      const v = (mockTodayInput.value||'').trim();
      if (!/^\d{4}-\d{2}-\d{2}$/.test(v)) { tick('YYYY-MM-DD ã§å…¥åŠ›'); return; }
      localStorage.setItem(MOCK_KEY, v);
      monthEl.value = anchorForDate(now());
      applyTemplatesForMonth(getMonthKey());
      preapplyNeighbors(getMonthKey());
      render();
      tick('ãƒ†ã‚¹ãƒˆæ—¥ã‚’è¨­å®šã—ã¾ã—ãŸ: '+v);
    };
    clearMockBtn.onclick = ()=>{
      localStorage.removeItem(MOCK_KEY);
      monthEl.value = anchorForDate(now());
      applyTemplatesForMonth(getMonthKey());
      preapplyNeighbors(getMonthKey());
      render();
      tick('ãƒ†ã‚¹ãƒˆæ—¥ã‚’è§£é™¤ï¼ˆå®Ÿæ™‚åˆ»ã«æˆ»ã—ã¾ã—ãŸï¼‰');
    };
  }

  closeSettingsBtn.addEventListener('click', ()=> settingsModal.classList.remove('show'));
  settingsModal.addEventListener('click', (e)=>{ if(e.target===settingsModal) settingsModal.classList.remove('show'); });
  saveSettingsBtn.addEventListener('click', ()=>{
    const v = toNumber(paydayInput.value||'');
    if(!Number.isFinite(v) || v<1 || v>31){ tick('ãƒ™ãƒ¼ã‚¹çµ¦æ–™æ—¥ã¯1ã€œ31ã§å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    paydayBase = v|0;
    adjustWeekends = !!adjWeekendsEl.checked;
    const raw = (holidaysInput.value||'').split(/[\s,]+/).map(s=>s.trim()).filter(Boolean);
    const userExtra = raw.map(s=>s.slice(0,10)).filter(s=>/^\d{4}-\d{2}-\d{2}$/.test(s));
    saveSilent(KEY_HOLIDAYS_USER, userExtra);

    const ics = load(KEY_HOLIDAYS, []);
    holidays = Array.from(new Set([...ics, ...userExtra])).sort();
    save(KEY_HOLIDAYS, holidays);

    monthEl.value = anchorForDate(now());
    applyTemplatesForMonth(getMonthKey());
    preapplyNeighbors(getMonthKey());
    render();
    settingsModal.classList.remove('show');
    tick('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
  });

  </script>
</body>
</html>
